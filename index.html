<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üßü Zombie Dice</title>
<link href="https://fonts.googleapis.com/css2?family=Creepster&family=Barlow+Condensed:wght@400;600;700&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0b0d0a;
  --surface: #121510;
  --surface2: #191d15;
  --surface3: #1f2419;
  --border: #252b1e;
  --border2: #303828;
  --green: #6ecb5a;
  --green-glow: rgba(110,203,90,0.25);
  --green-dim: #243d1b;
  --red: #d94f3d;
  --red-dim: #4a1a14;
  --red-glow: rgba(217,79,61,0.25);
  --yellow: #e8c43a;
  --yellow-dim: #3d3010;
  --yellow-glow: rgba(232,196,58,0.2);
  --text: #cdd5c5;
  --text-dim: #6b7562;
  --text-muted: #3d4436;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Barlow', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}
body::after {
  content:'';position:fixed;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
  pointer-events:none;z-index:0;opacity:.5;
}
.app { position:relative;z-index:1;max-width:480px;margin:0 auto;padding-bottom:72px; }

/* HEADER */
header {
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 16px 12px;
  border-bottom:1px solid var(--border);
  position:sticky;top:0;background:var(--bg);z-index:100;
}
header h1 {
  font-family:'Creepster',cursive;font-size:2rem;color:var(--green);
  text-shadow:0 0 16px rgba(110,203,90,.3);letter-spacing:2px;line-height:1;
}
.mode-pill {
  font-family:'Barlow Condensed',sans-serif;font-size:.7rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;
  background:var(--surface3);border:1px solid var(--border2);
  color:var(--yellow);border-radius:20px;padding:4px 10px;cursor:pointer;
}

/* MODE SHEET */
.sheet-backdrop { display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:300; }
.sheet-backdrop.open { display:block; }
.mode-sheet {
  display:none;
  position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:480px;
  background:var(--surface2);border-top:1px solid var(--border2);
  border-radius:20px 20px 0 0;padding:16px;z-index:301;
}
.mode-sheet.open { display:block; }
.sheet-title {
  font-family:'Barlow Condensed',sans-serif;font-size:.65rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);
  text-align:center;margin-bottom:12px;
}
.mode-option {
  display:flex;align-items:center;gap:12px;
  padding:12px 14px;border-radius:12px;cursor:pointer;
  margin-bottom:6px;border:1px solid transparent;transition:all .15s;
}
.mode-option.selected { background:var(--surface3);border-color:var(--border2); }
.mode-option.selected .mo-name { color:var(--green); }
.mo-check { font-size:1.1rem;width:20px;text-align:center; }
.mo-info .mo-name { font-weight:600;font-size:.95rem;margin-bottom:2px; }
.mo-info .mo-desc { font-size:.75rem;color:var(--text-dim);line-height:1.4; }

/* TURN BANNER */
.turn-banner {
  margin:12px 16px 0;padding:10px 14px;
  background:linear-gradient(135deg, var(--green-dim), transparent);
  border:1px solid var(--green);border-radius:12px;
  display:flex;align-items:center;gap:10px;
}
.turn-banner.hidden { display:none; }
.turn-pulse {
  width:10px;height:10px;border-radius:50%;background:var(--green);flex-shrink:0;
  animation:pulse 1.4s ease-in-out infinite;
}
@keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(110,203,90,.4)} 50%{box-shadow:0 0 0 6px transparent} }
.turn-name { font-family:'Barlow Condensed',sans-serif;font-size:1.05rem;font-weight:700; }
.turn-sub { font-size:.7rem;color:var(--text-dim); }

/* ROLL TRACKER */
.roll-tracker {
  margin:10px 16px;background:var(--surface);
  border:1px solid var(--border2);border-radius:16px;overflow:hidden;
}
.roll-tracker.hidden { display:none; }
.roll-header {
  display:flex;align-items:center;justify-content:space-between;
  padding:9px 14px;border-bottom:1px solid var(--border);
}
.roll-header-label {
  font-family:'Barlow Condensed',sans-serif;font-size:.65rem;
  font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);
}
.roll-counters { display:flex;gap:12px; }
.rc { font-family:'Barlow Condensed',sans-serif;font-size:.95rem;font-weight:700; }
.rc-brain { color:var(--green); }
.rc-shot  { color:var(--red); }
.rc-run   { color:var(--yellow); }

.dice-tray {
  padding:10px 12px;display:flex;gap:6px;flex-wrap:wrap;
  min-height:58px;align-items:center;
}
.die {
  width:44px;height:44px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:1.4rem;border:1.5px solid;
  animation:dieIn .15s ease both;
}
@keyframes dieIn { from{transform:scale(.5) rotate(-10deg);opacity:0} to{transform:scale(1) rotate(0);opacity:1} }
.die-brain  { background:var(--green-dim);border-color:var(--green);box-shadow:0 0 8px rgba(110,203,90,.2); }
.die-shot   { background:var(--red-dim);border-color:var(--red);box-shadow:0 0 8px rgba(217,79,61,.2); }
.die-runner { background:var(--yellow-dim);border-color:var(--yellow);box-shadow:0 0 8px rgba(232,196,58,.2); }
.die-empty  { border-style:dashed;border-color:var(--text-muted);color:var(--text-muted);font-size:.65rem;font-family:'Barlow Condensed',sans-serif;text-align:center;line-height:1.2; }

.tap-btns {
  display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;
  padding:8px 12px;border-top:1px solid var(--border);
}
.tap-btn {
  padding:11px 4px;border-radius:10px;border:1.5px solid;
  background:transparent;cursor:pointer;
  font-family:'Barlow Condensed',sans-serif;font-size:.82rem;font-weight:700;
  letter-spacing:.5px;display:flex;flex-direction:column;align-items:center;gap:3px;
  transition:all .1s;
}
.tap-btn:active { transform:scale(.92); }
.tap-brain { color:var(--green);border-color:var(--green-dim); }
.tap-brain:active { background:var(--green-dim); }
.tap-shot  { color:var(--red);border-color:var(--red-dim); }
.tap-shot:active  { background:var(--red-dim); }
.tap-run   { color:var(--yellow);border-color:var(--yellow-dim); }
.tap-run:active   { background:var(--yellow-dim); }
.tap-icon { font-size:1.25rem; }

.roll-actions { display:flex;gap:6px;padding:8px 12px 12px; }
.act-btn {
  flex:1;padding:10px;border-radius:10px;border:1.5px solid;
  font-family:'Barlow Condensed',sans-serif;font-size:.82rem;font-weight:700;
  letter-spacing:1px;cursor:pointer;text-transform:uppercase;background:transparent;
  transition:all .15s;
}
.act-bank  { color:var(--green);border-color:var(--green); }
.act-bank:active  { background:var(--green);color:#000; }
.act-bust  { color:var(--red);border-color:var(--red); }
.act-bust:active  { background:var(--red);color:#fff; }
.act-clear { color:var(--text-dim);border-color:var(--border2); }
.act-clear:active { background:var(--surface3); }
.act-bank.disabled { opacity:.35;pointer-events:none; }
.act-keep  { color:var(--yellow);border-color:var(--yellow-dim); }
.act-keep:active  { background:var(--yellow-dim); }
.act-keep.no-runners { opacity:.35;pointer-events:none; }

.bust-flash {
  position:fixed;inset:0;pointer-events:none;z-index:400;opacity:0;
  background:var(--red);
}
@keyframes bustFlash { 0%{opacity:.5} 100%{opacity:0} }
.bust-flash.show { animation:bustFlash .4s forwards; }

/* ADD PLAYER */
.add-row { display:flex;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);margin-top:12px; }
.add-row input {
  flex:1;background:var(--surface2);border:1px solid var(--border2);
  border-radius:10px;padding:10px 14px;color:var(--text);
  font-family:'Barlow',sans-serif;font-size:.95rem;outline:none;
  transition:border-color .2s;
}
.add-row input:focus { border-color:var(--green); }
.add-row input::placeholder { color:var(--text-dim); }
.btn-add {
  background:var(--green-dim);border:1px solid var(--green);color:var(--green);
  border-radius:10px;padding:10px 20px;font-weight:700;font-size:1.2rem;
  cursor:pointer;transition:all .15s;font-family:'Barlow',sans-serif;
}
.btn-add:active { background:var(--green);color:#000; }

/* PLAYERS */
.players { padding:0 16px;display:flex;flex-direction:column;gap:8px;margin-top:12px; }

.player-card {
  background:var(--surface);border:1px solid var(--border2);
  border-radius:14px;overflow:hidden;transition:border-color .2s;
}
.player-card.active-turn { border-color:var(--green); }
.player-card.winner { border-color:var(--yellow);box-shadow:0 0 16px rgba(232,196,58,.2); }

.pc-top { display:flex;align-items:center;padding:10px 14px;gap:10px; }
.pc-dot { width:7px;height:7px;border-radius:50%;background:var(--border2);flex-shrink:0;transition:all .2s; }
.active-turn .pc-dot { background:var(--green);box-shadow:0 0 6px var(--green); }
.pc-name {
  flex:1;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:1rem;
  min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.winner .pc-name::after { content:' üèÜ'; }
.pc-score {
  font-family:'Creepster',cursive;font-size:2rem;color:var(--green);
  text-shadow:0 0 10px rgba(110,203,90,.25);line-height:1;min-width:52px;text-align:right;
}
.pc-target { font-size:.85rem;color:var(--text-dim); }

.pc-last-roll {
  display:flex;align-items:center;gap:6px;
  padding:0 14px 8px;font-size:.75rem;color:var(--text-dim);flex-wrap:wrap;
}
.pc-last-roll.empty { display:none; }
.lr-chip {
  padding:2px 7px;border-radius:20px;font-weight:600;font-size:.7rem;
}
.lr-brain  { background:var(--green-dim);color:var(--green); }
.lr-shot   { background:var(--red-dim);color:var(--red); }
.lr-runner { background:var(--yellow-dim);color:var(--yellow); }

.pc-controls { display:flex;border-top:1px solid var(--border); }
.pc-btn {
  flex:1;background:transparent;border:none;border-right:1px solid var(--border);
  color:var(--text-dim);padding:9px 4px;cursor:pointer;
  font-family:'Barlow Condensed',sans-serif;font-size:.74rem;font-weight:600;
  display:flex;flex-direction:column;align-items:center;gap:2px;transition:background .15s;
  letter-spacing:.3px;
}
.pc-btn:last-child { border-right:none; }
.pc-btn:active { background:var(--surface3); }
.pc-btn .pbi { font-size:.95rem; }
.pc-btn.set-turn { color:var(--green); }
.pc-btn.rem-btn  { color:var(--text-muted); }

/* HISTORY */
.pc-history { display:none;border-top:1px solid var(--border); }
.pc-history.open { display:block; }
.ph-entry {
  display:flex;justify-content:space-between;align-items:center;
  padding:6px 14px;border-bottom:1px solid var(--border);
}
.ph-entry:last-child { border-bottom:none; }
.ph-turn { font-size:.65rem;color:var(--text-muted);min-width:24px; }
.ph-dice { display:flex;gap:4px;flex:1;padding:0 8px;flex-wrap:wrap; }
.ph-chip { padding:2px 6px;border-radius:10px;font-size:.68rem;font-weight:600; }
.ph-brain { background:var(--green-dim);color:var(--green); }
.ph-shot  { background:var(--red-dim);color:var(--red); }
.ph-run   { background:var(--yellow-dim);color:var(--yellow); }
.ph-delta { font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:.85rem; }
.ph-pos   { color:var(--green); }
.ph-neg   { color:var(--red); }
.ph-zero  { color:var(--text-dim); }

/* BOTTOM BAR */
.bottom-bar {
  position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:480px;
  background:var(--surface);border-top:1px solid var(--border2);
  display:flex;z-index:200;
}
.bar-btn {
  flex:1;background:transparent;border:none;border-right:1px solid var(--border);
  color:var(--text-dim);padding:11px 6px;cursor:pointer;
  font-family:'Barlow Condensed',sans-serif;font-size:.68rem;font-weight:600;
  letter-spacing:1px;text-transform:uppercase;
  display:flex;flex-direction:column;align-items:center;gap:3px;transition:color .2s;
}
.bar-btn:last-child { border-right:none; }
.bar-btn:active { color:var(--green); }
.bar-btn.active-bar { color:var(--yellow); }
.bi { font-size:1.1rem; }

/* WIN OVERLAY */
.win-overlay {
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.88);z-index:500;
  align-items:center;justify-content:center;flex-direction:column;
  text-align:center;padding:24px;
}
.win-overlay.show { display:flex; }
.win-overlay h2 {
  font-family:'Creepster',cursive;font-size:3.2rem;color:var(--yellow);
  text-shadow:0 0 40px rgba(232,196,58,.5);letter-spacing:3px;
  animation:winPop .4s cubic-bezier(.17,.89,.32,1.28) both;
}
@keyframes winPop { from{transform:scale(.5);opacity:0} to{transform:scale(1);opacity:1} }
.win-player { font-size:1.6rem;font-weight:700;color:var(--green);margin:8px 0 4px; }
.win-sub    { font-size:.9rem;color:var(--text-dim);margin-bottom:24px; }
.win-btns   { display:flex;gap:10px; }
.win-btn {
  padding:13px 28px;border-radius:12px;border:2px solid var(--yellow);
  background:transparent;color:var(--yellow);
  font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:.95rem;
  letter-spacing:1px;cursor:pointer;text-transform:uppercase;transition:all .15s;
}
.win-btn:active { background:var(--yellow);color:#000; }

/* EMPTY STATE */
.empty-state { text-align:center;padding:44px 24px;color:var(--text-dim); }
.es-icon { font-size:3rem;margin-bottom:12px; }
.es-text { font-size:.9rem;line-height:1.6; }
</style>
</head>
<body>
<div class="app">

  <header>
    <h1>üßü Zombie Dice</h1>
    <button class="mode-pill" id="modePill">Base Game ‚ñæ</button>
  </header>

  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="mode-sheet" id="modeSheet">
    <div class="sheet-title">Game Mode</div>
    <div class="mode-option selected" data-mode="base">
      <div class="mo-check">‚úì</div>
      <div class="mo-info">
        <div class="mo-name">Base Game</div>
        <div class="mo-desc">13 dice ‚Äî green (brain-heavy), yellow (balanced), red (shotgun-heavy). First to 13 wins.</div>
      </div>
    </div>
    <div class="mode-option" data-mode="df">
      <div class="mo-check"></div>
      <div class="mo-info">
        <div class="mo-name">+ Double Feature</div>
        <div class="mo-desc">Adds the Hunk (extra brains) and Hottie (extra runners) special dice.</div>
      </div>
    </div>
    <div class="mode-option" data-mode="bus">
      <div class="mo-check"></div>
      <div class="mo-info">
        <div class="mo-name">+ School Bus</div>
        <div class="mo-desc">Adds a yellow school bus die. Roll it to rescue students worth extra brains.</div>
      </div>
    </div>
    <div class="mode-option" data-mode="all">
      <div class="mo-check"></div>
      <div class="mo-info">
        <div class="mo-name">All Expansions</div>
        <div class="mo-desc">Full set: base + Double Feature specials + School Bus. Maximum chaos.</div>
      </div>
    </div>
  </div>

  <!-- Turn Banner -->
  <div class="turn-banner hidden" id="turnBanner">
    <div class="turn-pulse"></div>
    <div>
      <div class="turn-name" id="turnName"></div>
      <div class="turn-sub">Tap dice below to log this turn</div>
    </div>
  </div>

  <!-- Roll Tracker -->
  <div class="roll-tracker hidden" id="rollTracker">
    <div class="roll-header">
      <div class="roll-header-label">Current Roll</div>
      <div class="roll-counters">
        <div class="rc rc-brain">üß† <span id="rcBrains">0</span></div>
        <div class="rc rc-shot">üí• <span id="rcShots">0</span></div>
        <div class="rc rc-run">üèÉ <span id="rcRunners">0</span></div>
      </div>
    </div>
    <div class="dice-tray" id="diceTray"></div>
    <div class="tap-btns">
      <button class="tap-btn tap-brain" id="tapBrain"><span class="tap-icon">üß†</span>BRAIN</button>
      <button class="tap-btn tap-shot"  id="tapShot"><span class="tap-icon">üí•</span>SHOTGUN</button>
      <button class="tap-btn tap-run"   id="tapRun"><span class="tap-icon">üèÉ</span>RUNNER</button>
    </div>
    <div class="roll-actions">
      <button class="act-btn act-bank disabled" id="bankBtn">üß† Bank It</button>
      <button class="act-btn act-keep no-runners" id="keepRollingBtn">üèÉ Keep Rolling</button>
      <button class="act-btn act-bust" id="manualBustBtn">üí• Bust</button>
    </div>
    <div style="display:flex;padding:0 12px 10px;gap:6px;justify-content:flex-end;">
      <button class="act-btn act-clear" id="clearRollBtn" style="flex:0 0 auto;padding:6px 14px;font-size:.72rem;">‚úï Clear All</button>
    </div>
  </div>

  <!-- Add Player -->
  <div class="add-row">
    <input type="text" id="playerInput" placeholder="Add player..." maxlength="20">
    <button class="btn-add" id="addBtn">+</button>
  </div>

  <!-- Players -->
  <div class="players" id="playersList"></div>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar">
  <button class="bar-btn" id="undoBtn"><span class="bi">‚Ü©Ô∏è</span>Undo</button>
  <button class="bar-btn" id="historyToggleBtn"><span class="bi">üìú</span>History</button>
  <button class="bar-btn" id="resetBtn"><span class="bi">üíÄ</span>New Game</button>
</div>

<!-- Bust Flash -->
<div class="bust-flash" id="bustFlash"></div>

<!-- Win Overlay -->
<div class="win-overlay" id="winOverlay">
  <h2>BRAAAAINS!</h2>
  <div class="win-player" id="winPlayer"></div>
  <div class="win-sub" id="winSub"></div>
  <div class="win-btns">
    <button class="win-btn" id="keepPlayingBtn">Keep Playing</button>
    <button class="win-btn" id="newGameBtn">New Game</button>
  </div>
</div>

<script>
const MODES = {
  base: { name:'Base Game', winTarget:13 },
  df:   { name:'+ Double Feature', winTarget:13 },
  bus:  { name:'+ School Bus', winTarget:13 },
  all:  { name:'All Expansions', winTarget:13 },
};

let state = { mode:'base', players:[], currentTurn:0, history:[], showHistory:false, winnerFound:false };
let nextId = 1;
let turnNum = 1;
let roll = { brains:0, shots:0, runners:0, dice:[] };

function save() {
  try { localStorage.setItem('zd3', JSON.stringify({state,nextId,turnNum})); } catch(e){}
}
function load() {
  try {
    const raw = localStorage.getItem('zd3');
    if(!raw) return;
    const d = JSON.parse(raw);
    state=d.state; nextId=d.nextId||1; turnNum=d.turnNum||1;
  } catch(e){}
}

function esc(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function currentPlayer(){ return state.players[state.currentTurn]||null; }

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
function render(){
  const mode = MODES[state.mode];
  document.getElementById('modePill').textContent = mode.name+' ‚ñæ';

  document.querySelectorAll('.mode-option').forEach(el=>{
    const sel = el.dataset.mode===state.mode;
    el.classList.toggle('selected',sel);
    el.querySelector('.mo-check').textContent = sel?'‚úì':'';
  });

  const has = state.players.length>0;
  document.getElementById('turnBanner').classList.toggle('hidden',!has);
  document.getElementById('rollTracker').classList.toggle('hidden',!has);
  if(has){
    const cp = currentPlayer();
    document.getElementById('turnName').textContent = cp ? cp.name+"'s Turn" : '';
  }

  renderRoll();
  renderPlayers();
}

function renderRoll(){
  document.getElementById('rcBrains').textContent   = roll.brains;
  document.getElementById('rcShots').textContent    = roll.shots;
  document.getElementById('rcRunners').textContent  = roll.runners;

  const tray = document.getElementById('diceTray');
  if(roll.dice.length===0){
    tray.innerHTML='<div class="die die-empty">tap<br>dice</div>';
  } else {
    tray.innerHTML = roll.dice.map(d=>{
      if(d==='brain')  return '<div class="die die-brain">üß†</div>';
      if(d==='shot')   return '<div class="die die-shot">üí•</div>';
      if(d==='runner') return '<div class="die die-runner">üèÉ</div>';
    }).join('');
  }
  document.getElementById('bankBtn').classList.toggle('disabled', roll.brains===0);
  document.getElementById('keepRollingBtn').classList.toggle('no-runners', roll.runners===0);
}

function renderPlayers(){
  const list = document.getElementById('playersList');
  if(state.players.length===0){
    list.innerHTML='<div class="empty-state"><div class="es-icon">üßü</div><div class="es-text">Add players above<br>to start shambling</div></div>';
    return;
  }
  const wt = MODES[state.mode].winTarget;
  list.innerHTML = state.players.map((p,i)=>{
    const isActive = i===state.currentTurn;
    const isWinner = state.winnerFound && p.score>=wt;
    const ph = state.history.filter(h=>h.pid===p.id);
    const last = ph.length ? ph[ph.length-1] : null;

    const lastHtml = last ? `<div class="pc-last-roll">
      <span>Last:</span>
      ${last.busted ? '<span class="lr-chip lr-shot">BUST</span>' : ''}
      ${!last.busted&&last.brains  >0?`<span class="lr-chip lr-brain">üß†√ó${last.brains}</span>`:''}
      ${!last.busted&&last.shots   >0?`<span class="lr-chip lr-shot">üí•√ó${last.shots}</span>`:''}
      ${!last.busted&&last.runners >0?`<span class="lr-chip lr-runner">üèÉ√ó${last.runners}</span>`:''}
    </div>` : '<div class="pc-last-roll empty"></div>';

    const histRows = ph.slice(-7).reverse().map(h=>`
      <div class="ph-entry">
        <span class="ph-turn">T${h.turn}</span>
        <div class="ph-dice">
          ${h.busted?'<span class="ph-chip ph-shot">üí• BUST</span>':''}
          ${!h.busted&&h.brains >0?`<span class="ph-chip ph-brain">üß†√ó${h.brains}</span>`:''}
          ${!h.busted&&h.shots  >0?`<span class="ph-chip ph-shot">üí•√ó${h.shots}</span>`:''}
          ${!h.busted&&h.runners>0?`<span class="ph-chip ph-run">üèÉ√ó${h.runners}</span>`:''}
        </div>
        <span class="ph-delta ${h.delta>0?'ph-pos':h.delta<0?'ph-neg':'ph-zero'}">${h.delta>0?'+':''}${h.delta}</span>
      </div>`).join('');

    return `<div class="player-card ${isActive?'active-turn':''} ${isWinner?'winner':''}">
      <div class="pc-top">
        <div class="pc-dot"></div>
        <div class="pc-name">${esc(p.name)}</div>
        <div class="pc-score">${p.score}<span class="pc-target">/${wt}</span></div>
      </div>
      ${lastHtml}
      <div class="pc-controls">
        ${!isActive?`<button class="pc-btn set-turn" onclick="setTurn(${i})"><span class="pbi">‚ñ∂Ô∏è</span>Set Turn</button>`:''}
        <button class="pc-btn" onclick="adj(${p.id},1)"><span class="pbi">üß†</span>+1</button>
        <button class="pc-btn" onclick="adj(${p.id},-1)"><span class="pbi">‚ûñ</span>‚àí1</button>
        <button class="pc-btn rem-btn" onclick="removePlayer(${p.id})"><span class="pbi">ü™¶</span>Remove</button>
      </div>
      ${state.showHistory&&histRows?`<div class="pc-history open">${histRows}</div>`:''}
    </div>`;
  }).join('');
}

/* ‚îÄ‚îÄ ROLL ‚îÄ‚îÄ */
function tapDie(type){
  roll.dice.push(type);
  if(type==='brain')  roll.brains++;
  if(type==='shot')   roll.shots++;
  if(type==='runner') roll.runners++;
  renderRoll();
  if(roll.shots>=3) setTimeout(()=>bust(true),130);
}

function bank(){
  if(roll.brains===0) return;
  const cp=currentPlayer(); if(!cp) return;
  pushHistory(cp.id,roll.brains,roll.shots,roll.runners,false);
  cp.score+=roll.brains;
  clearRoll();
  checkWin(cp);
  advanceTurn();
  save(); render();
}

function bust(auto){
  const cp=currentPlayer(); if(!cp) return;
  flash();
  pushHistory(cp.id,roll.brains,roll.shots,roll.runners,true);
  clearRoll();
  advanceTurn();
  save(); render();
}

function flash(){
  const el=document.getElementById('bustFlash');
  el.classList.remove('show');
  void el.offsetWidth;
  el.classList.add('show');
}

function keepRolling(){
  // Remove all runners from the tray, keep brains and shotguns
  roll.dice = roll.dice.filter(d => d !== 'runner');
  roll.runners = 0;
  renderRoll();
}

function clearRoll(){
  roll={brains:0,shots:0,runners:0,dice:[]};
  renderRoll();
}

function advanceTurn(){
  if(!state.players.length) return;
  turnNum++;
  state.currentTurn=(state.currentTurn+1)%state.players.length;
}

function pushHistory(pid,brains,shots,runners,busted){
  state.history.push({pid,turn:turnNum,brains,shots,runners,busted,delta:busted?0:brains});
  if(state.history.length>400) state.history.shift();
}

/* ‚îÄ‚îÄ PLAYERS ‚îÄ‚îÄ */
function addPlayer(){
  const inp=document.getElementById('playerInput');
  const name=inp.value.trim(); if(!name) return;
  state.players.push({id:nextId++,name,score:0});
  inp.value='';
  save(); render();
}

function removePlayer(id){
  const idx=state.players.findIndex(p=>p.id===id);
  state.players=state.players.filter(p=>p.id!==id);
  state.history=state.history.filter(h=>h.pid!==id);
  if(!state.players.length){ state.currentTurn=0; }
  else if(idx<=state.currentTurn){ state.currentTurn=Math.max(0,state.currentTurn-1)%state.players.length; }
  save(); render();
}

function setTurn(i){
  clearRoll();
  state.currentTurn=i;
  save(); render();
}

function adj(id,delta){
  const p=state.players.find(p=>p.id===id); if(!p) return;
  const ns=Math.max(0,p.score+delta);
  const actual=ns-p.score; if(actual===0) return;
  pushHistory(id,actual>0?actual:0,0,0,false);
  if(actual<0) state.history[state.history.length-1].delta=actual;
  p.score=ns;
  checkWin(p);
  save(); render();
}

/* ‚îÄ‚îÄ WIN ‚îÄ‚îÄ */
function checkWin(p){
  if(!state.winnerFound && p.score>=MODES[state.mode].winTarget){
    state.winnerFound=true;
    document.getElementById('winPlayer').textContent=p.name;
    document.getElementById('winSub').textContent=`${p.score} brains ‚Äî first to ${MODES[state.mode].winTarget}!`;
    document.getElementById('winOverlay').classList.add('show');
  }
}

/* ‚îÄ‚îÄ UNDO ‚îÄ‚îÄ */
function undo(){
  if(!state.history.length) return;
  const last=state.history.pop();
  const p=state.players.find(p=>p.id===last.pid);
  if(p&&last.delta!==0){
    p.score=Math.max(0,p.score-last.delta);
    state.winnerFound=state.players.some(pl=>pl.score>=MODES[state.mode].winTarget);
  }
  save(); render();
}

/* ‚îÄ‚îÄ NEW GAME ‚îÄ‚îÄ */
function newGame(){
  state.players.forEach(p=>p.score=0);
  state.currentTurn=0; state.history=[]; state.winnerFound=false; turnNum=1;
  clearRoll();
  document.getElementById('winOverlay').classList.remove('show');
  save(); render();
}

/* ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ */
document.getElementById('addBtn').addEventListener('click',addPlayer);
document.getElementById('playerInput').addEventListener('keydown',e=>{if(e.key==='Enter')addPlayer();});
document.getElementById('tapBrain').addEventListener('click',()=>tapDie('brain'));
document.getElementById('tapShot').addEventListener('click',()=>tapDie('shot'));
document.getElementById('tapRun').addEventListener('click',()=>tapDie('runner'));
document.getElementById('keepRollingBtn').addEventListener('click', keepRolling);

document.getElementById('bankBtn').addEventListener('click',bank);
document.getElementById('manualBustBtn').addEventListener('click',()=>bust(false));
document.getElementById('clearRollBtn').addEventListener('click',()=>{clearRoll();render();});
document.getElementById('undoBtn').addEventListener('click',undo);
document.getElementById('historyToggleBtn').addEventListener('click',()=>{
  state.showHistory=!state.showHistory;
  document.getElementById('historyToggleBtn').classList.toggle('active-bar',state.showHistory);
  render();
});
document.getElementById('resetBtn').addEventListener('click',()=>{
  if(confirm('Reset all scores and start a new game?')) newGame();
});
document.getElementById('keepPlayingBtn').addEventListener('click',()=>document.getElementById('winOverlay').classList.remove('show'));
document.getElementById('newGameBtn').addEventListener('click',newGame);
document.getElementById('modePill').addEventListener('click',()=>{
  document.getElementById('sheetBackdrop').classList.add('open');
  document.getElementById('modeSheet').classList.add('open');
});
document.getElementById('sheetBackdrop').addEventListener('click',()=>{
  document.getElementById('sheetBackdrop').classList.remove('open');
  document.getElementById('modeSheet').classList.remove('open');
});
document.querySelectorAll('.mode-option').forEach(el=>{
  el.addEventListener('click',()=>{
    state.mode=el.dataset.mode;
    document.getElementById('sheetBackdrop').classList.remove('open');
    document.getElementById('modeSheet').classList.remove('open');
    save(); render();
  });
});

load(); render();
</script>
</body>
</html>
